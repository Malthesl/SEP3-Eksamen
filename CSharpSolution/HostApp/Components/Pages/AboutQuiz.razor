@page "/quiz/{id:int}"
@using ApiContracts
@using HostApp.Components.Modals
@using HostApp.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject IQuizService QuizService;
@inject IQuestionService QuestionService;
@inject NavigationManager Nav;

<PageTitle>Kahoot++ | Quiz ikke fundet</PageTitle>

<div class="centered-page">
    <div class="wide-content-page">
        @if (Quiz is not null)
        {
            <PageTitle>Kahoot++ | Om @Quiz.Title</PageTitle>
            
            <h1>
                <span class="quiz-title">@Quiz.Title</span>
                @if (Quiz.Visibility == "public")
                {
                    <span class="visibility-tag visibility-public">Synlig</span>
                }
                else
                {
                    <span class="visibility-tag visibility-private">Privat</span>
                }
            </h1>
            <h5>Lavet af @Quiz.Creator.Username</h5>

            <p>Indeholder @Quiz.QuestionCount spørgsmål:</p>
            <ul>
                @foreach (var question in Questions)
                {
                    <li>@question.Title</li>
                }
            </ul>

            <AuthorizeView>
                <Authorized>
                    <div class="options">
                        <NavLink href=@("/quiz/" + Quiz.Id + "/play")>
                            <button>Spil nu</button>
                        </NavLink>
                        @if (context.User.FindFirst("Id")!.Value == Quiz.CreatorId.ToString())
                        {
                            <NavLink href=@("/quiz/" + Quiz.Id + "/edit")>
                                <button>Rediger quiz</button>
                            </NavLink>
                            <button @onclick="() => _visibilityModal.Show()">Ændre synlighed quiz</button>
                            <button @onclick="() => _renameModal.Show()">Omdøb quiz</button>
                            <button style="color: red" @onclick="() => _deleteModal.Show()">Slet quiz</button>
                        }
                        <p class="error-text">@ErrorText</p>
                    </div>
                </Authorized>
            </AuthorizeView>
        }
        else
        {
            <p><em>Quiz ikke fundet :(</em></p>
        }
    </div>
</div>

<ConfirmModal @ref="_deleteModal"
              Title="Bekræft sletning"
              Message="Er du sikker på, at du vil slette quizzen?"
              OnClose="HandleDeleteConfirmation" />

<RenameModal @ref="_renameModal"
             Title="@($"Omdøb{Quiz?.Title}")"
             Message="Hvad skal quizzen omdøbes til?"
             Name="@Quiz?.Title"
             OnClose="HandleRename" />

<OptionsModal @ref="_visibilityModal"
              Title="Vælg synlighed for din quiz"
              Message="Vælg en synlighed for din quiz:"
              Value="@Quiz?.Visibility"
              Options="@(["Offentlig", "Privat"])"
              OptionValues="@(["public", "private"])"
              OnClose="HandleVisibility" />

@code {
    private ConfirmModal? _deleteModal;
    private RenameModal? _renameModal;
    private OptionsModal? _visibilityModal;

    private string? ErrorText { get; set; }

    [Parameter] public int Id { get; set; }

    private QuizDTO Quiz { get; set; }
    private List<QuestionDTO> Questions { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        Quiz = await QuizService.GetQuiz(Id);
        Questions = await QuestionService.GetQuestionsFromQuiz(Id);
    }

    private async Task HandleDeleteConfirmation(bool confirmed)
    {
        if (confirmed)
        {
            await QuizService.DeleteQuiz(Quiz.Id);
            Nav.NavigateTo("/my-quizzes");
        }
    }

    private async Task HandleRename(string? newName)
    {
        if (String.IsNullOrWhiteSpace(newName))
        {
            ErrorText = "Titlen kan ikke være tom";
            return;
        }
        
        if (Quiz.Title != newName)
        {
            Quiz = await QuizService.UpdateQuiz(Id, newName, Quiz.Visibility);
        }
    }

    private async Task HandleVisibility(string? newVisibility)
    {
        if (newVisibility != null && Quiz.Visibility != newVisibility)
        {
            Quiz = await QuizService.UpdateQuiz(Id, Quiz.Title, newVisibility);
        }
    }

}